# NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
# RUN: llc -mtriple=aarch64 -run-pass=early-machinelicm -verify-machineinstrs -o - %s | FileCheck %s

# This test verifies that cross-register-class copies (e.g., between GPR and FPR)
# ARE hoisted out of loops by MachineLICM, as they translate to expensive
# instructions like FMOV (2-6 cycles) on AArch64.

---
name: cross_regclass_copy_hoisted
tracksRegLiveness: true
registers:
  - { id: 0, class: gpr64 }
  - { id: 1, class: gpr64 }
  - { id: 2, class: fpr64 }
body: |
  ; CHECK-LABEL: name: cross_regclass_copy_hoisted
  ; CHECK: bb.0:
  ; CHECK-NEXT:   successors: %bb.1(0x80000000)
  ; CHECK-NEXT:   liveins: $x0, $d0
  ; CHECK-NEXT: {{  $}}
  ; CHECK-NEXT:   %0:gpr64 = COPY $x0
  ; CHECK-NEXT:   %2:fpr64 = COPY $d0
  ; CHECK-NEXT:   %1:gpr64 = COPY %2
  ; CHECK-NEXT:   B %bb.1
  ; CHECK-NEXT: {{  $}}
  ; CHECK-NEXT: bb.1:
  ; CHECK-NEXT:   successors: %bb.1(0x40000000), %bb.2(0x40000000)
  ; CHECK-NEXT: {{  $}}
  ; CHECK-NEXT:   %0:gpr64 = ADDXri %0, 1, 0
  ; CHECK-NEXT:   $xzr = SUBSXri %0, 100, 0, implicit-def $nzcv
  ; CHECK-NEXT:   Bcc 11, %bb.1, implicit $nzcv
  ; CHECK-NEXT:   B %bb.2
  ; CHECK-NEXT: {{  $}}
  ; CHECK-NEXT: bb.2:
  ; CHECK-NEXT: {{  $}}
  ; CHECK-NEXT:   $x0 = COPY %1
  ; CHECK-NEXT:   RET_ReallyLR implicit $x0
  bb.0:
    liveins: $x0, $d0
    %0:gpr64 = COPY $x0
    %2:fpr64 = COPY $d0
    B %bb.1

  bb.1:
    ; This COPY between FPR64 and GPR64 should be hoisted
    %1:gpr64 = COPY %2:fpr64
    %0:gpr64 = ADDXri %0:gpr64, 1, 0
    $xzr = SUBSXri %0:gpr64, 100, 0, implicit-def $nzcv
    Bcc 11, %bb.1, implicit $nzcv
    B %bb.2

  bb.2:
    $x0 = COPY %1:gpr64
    RET_ReallyLR implicit $x0
...
